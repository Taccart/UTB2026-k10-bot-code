<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>System & Environment</title>
  <link rel="stylesheet" href="./style.css">
  <style>
    .metrics-container {
      /* max-width: 1200px; */
      margin: 0 auto;
    }
    .metrics-grid {
      width: 100%;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 400px));
      gap: 20px;
      margin: 20px 0;
      justify-content: center;
    }
    .metric-panel {
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    .metric-header h2 {
      margin: 0;
      color: #333;
      font-size: 1.3em;
    }
    .metric-header .btn {
      padding: 8px 15px;
      font-size: 0.9em;
    }
    .metric-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f5f5f5;
    }
    .metric-row:last-child {
      border-bottom: none;
    }
    .metric-label {
      font-weight: bold;
      color: #555;
    }
    .metric-value {
      color: #333;
      font-family: 'Courier New', monospace;
    }
    .metric-highlight {
      background: #e8f5e9;
      padding: 2px 8px;
      border-radius: 3px;
      color: #2e7d32;
      font-weight: bold;
    }
    .metric-warning {
      background: #fff3e0;
      padding: 2px 8px;
      border-radius: 3px;
      color: #e65100;
      font-weight: bold;
    }
    .metric-error {
      background: #ffebee;
      padding: 2px 8px;
      border-radius: 3px;
      color: #c62828;
      font-weight: bold;
    }
    .loading-indicator {
      text-align: center;
      padding: 20px;
      color: #999;
    }
    .error-message {
      color: #f44336;
      background: #ffebee;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .timestamp {
      font-size: 0.85em;
      color: #999;
      text-align: right;
      padding-top: 10px;
      font-style: italic;
    }
    .messages-list {
      max-height: 300px;
      overflow-y: auto;
      background: #f9f9f9;
      padding: 10px;
      border-radius: 3px;
      margin-top: 10px;
    }
    .message-item {
      padding: 8px;
      margin: 5px 0;
      background: white;
      border-left: 3px solid #2196F3;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      word-break: break-all;
    }
    .accelerometer-values {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .accel-axis {
      text-align: center;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 3px;
    }
    .accel-axis-label {
      font-weight: bold;
      color: #666;
      font-size: 0.9em;
    }
    .accel-axis-value {
      font-size: 1.2em;
      color: #333;
      font-family: 'Courier New', monospace;
      margin-top: 5px;
    }
    .metric-graph {
      width: 270px;
      height: 90px;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 3px;
      background: #fafafa;
    }
    .graph-container {
      margin-top: 15px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 3px;
    }
    .graph-title {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 5px;
      font-weight: bold;
    }
    @media (max-width: 768px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="metrics-container">
    <h1 id="pageTitle">üìä System Metrics Dashboard <span id="titleStatus" style="font-size: 0.6em; color: #999;"></span></h1>
    
    <div class="panel">
      <a href="/" class="btn">‚Üê Back to Home</a>
      <button onclick="refreshAllMetrics()" class="btn">üîÑ Refresh All</button>
      <button id="autoRefreshBtn" onclick="toggleAutoRefresh()" class="btn">‚è±Ô∏è Auto-Refresh: OFF</button>
    </div>    <div class="metrics-grid">
      <!-- K10 Sensors Metrics -->
      <div class="metric-panel">
        <div class="metric-header">
          <h2>üå°Ô∏è Sensors</h2>
          <button onclick="refreshSensors()" class="btn">üîÑ Refresh</button>
        </div>
        <div id="sensors-content">
          <div class="loading-indicator">Loading sensor data...</div>
        </div>
      </div>

      <!-- UDP Service Metrics -->
      <div class="metric-panel">
        <div class="metric-header">
          <h2>üì° UDP</h2>
          <button onclick="refreshUDP()" class="btn">üîÑ Refresh</button>
        </div>
        <div id="udp-content">
          <div class="loading-indicator">Loading UDP statistics...</div>
        </div>
      </div>

      <!-- Board Info Metrics -->
      <div class="metric-panel">
        <div class="metric-header">
          <h2>üñ•Ô∏è Board</h2>
          <button onclick="refreshBoardInfo()" class="btn">üîÑ Refresh</button>
        </div>
        <div id="board-content">
          <div class="loading-indicator">Loading board information...</div>
        </div>
      </div>



    </div>
  </div>

  <script>
    // Data storage for graphs (last 100 values)
    const metric_history = {
      light: [],
      temperature: [],
      humidity: [],
      microphone: [],
      accel_x: [],
      accel_y: [],
      accel_z: [],
      udp_total: [],
      udp_dropped: []
    };
    
    const max_history_length = 100;
    
    // Add value to history array
    function addToHistory(array, value) {
      if (value !== undefined && value !== null && !isNaN(value)) {
        array.push(value);
        if (array.length > max_history_length) {
          array.shift();
        }
      }
    }
    
    // Draw simple line graph on canvas
    function drawGraph(canvasId, data, color = '#2196F3') {
      const canvas = document.getElementById(canvasId);
      if (!canvas || !data || data.length === 0) return;
      
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      const padding = 5;
      
      // Clear canvas
      ctx.clearRect(0, 0, width, height);
      ctx.fillStyle = '#fafafa';
      ctx.fillRect(0, 0, width, height);
      
      // Find min/max for scaling
      const min_val = Math.min(...data);
      const max_val = Math.max(...data);
      const range = max_val - min_val || 1;
      
      // Draw grid lines
      ctx.strokeStyle = '#e0e0e0';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = padding + (height - 2 * padding) * i / 4;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();
      }
      
      // Draw line graph
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      
      for (let i = 0; i < data.length; i++) {
        const x = padding + (width - 2 * padding) * i / (max_history_length - 1);
        const y = height - padding - ((data[i] - min_val) / range) * (height - 2 * padding);
        
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      }
      
      ctx.stroke();
      
      // Draw min/max labels
      ctx.fillStyle = '#666';
      ctx.font = '10px Arial';
      ctx.fillText(max_val.toFixed(1), padding + 2, padding + 10);
      ctx.fillText(min_val.toFixed(1), padding + 2, height - padding - 2);
    }
    
    // Fetch K10 Sensors metrics
    async function refreshSensors() {
      const container = document.getElementById('sensors-content');
      
      try {
        const response = await fetch('/api/sensors/v1');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Store values in history if auto-refresh is active
        if (autoRefreshEnabled) {
          addToHistory(metric_history.light, data.light);
          addToHistory(metric_history.temperature, data.celcius);
          addToHistory(metric_history.humidity, data.hum_rel);
          addToHistory(metric_history.microphone, data.mic_data);
          if (data.accelerometer && Array.isArray(data.accelerometer)) {
            addToHistory(metric_history.accel_x, data.accelerometer[0]);
            addToHistory(metric_history.accel_y, data.accelerometer[1]);
            addToHistory(metric_history.accel_z, data.accelerometer[2]);
          }
        }
        
        let html = '';
        
        // Light sensor
        html += `
          <div class="metric-row">
            <span class="metric-label">üí° Light Level:</span>
            <span class="metric-value">${data.light !== undefined ? data.light.toFixed(1) : 'N/A'}</span>
          </div>
        `;
        if (autoRefreshEnabled && metric_history.light.length > 1) {
          html += `
            <div class="graph-container">
              <div class="graph-title">Light Level History</div>
              <canvas id="graph-light" class="metric-graph" ></canvas>
            </div>
          `;
        }
        
        // Temperature
        html += `
          <div class="metric-row">
            <span class="metric-label">üå°Ô∏è Temperature:</span>
            <span class="metric-value">${data.celcius !== undefined ? data.celcius.toFixed(1) + '¬∞C' : 'N/A'}</span>
          </div>
        `;
        if (autoRefreshEnabled && metric_history.temperature.length > 1) {
          html += `
            <div class="graph-container">
              <div class="graph-title">Temperature History</div>
              <canvas id="graph-temp" class="metric-graph" ></canvas>
            </div>
          `;
        }
        
        // Humidity
        html += `
          <div class="metric-row">
            <span class="metric-label">üíß Humidity:</span>
            <span class="metric-value">${data.hum_rel !== undefined ? data.hum_rel.toFixed(1) + '%' : 'N/A'}</span>
          </div>
        `;
        if (autoRefreshEnabled && metric_history.humidity.length > 1) {
          html += `
            <div class="graph-container">
              <div class="graph-title">Humidity History</div>
              <canvas id="graph-humidity" class="metric-graph" ></canvas>
            </div>
          `;
        }
        
        // Microphone
        html += `
          <div class="metric-row">
            <span class="metric-label">üé§ Microphone:</span>
            <span class="metric-value">${data.mic_data !== undefined ? data.mic_data : 'N/A'}</span>
          </div>
        `;
        if (autoRefreshEnabled && metric_history.microphone.length > 1) {
          html += `
            <div class="graph-container">
              <div class="graph-title">Microphone History</div>
              <canvas id="graph-mic" class="metric-graph" ></canvas>
            </div>
          `;
        }
        
        // Accelerometer
        if (data.accelerometer && Array.isArray(data.accelerometer)) {
          html += `
            <div class="metric-row">
              <span class="metric-label">üìê Accelerometer:</span>
            </div>
            <div class="accelerometer-values">
              <div class="accel-axis">
                <div class="accel-axis-label">X</div>
                <div class="accel-axis-value">${data.accelerometer[0] !== undefined ? data.accelerometer[0].toFixed(2) : 'N/A'}</div>
              </div>
              <div class="accel-axis">
                <div class="accel-axis-label">Y</div>
                <div class="accel-axis-value">${data.accelerometer[1] !== undefined ? data.accelerometer[1].toFixed(2) : 'N/A'}</div>
              </div>
              <div class="accel-axis">
                <div class="accel-axis-label">Z</div>
                <div class="accel-axis-value">${data.accelerometer[2] !== undefined ? data.accelerometer[2].toFixed(2) : 'N/A'}</div>
              </div>
            </div>
          `;
          if (autoRefreshEnabled && metric_history.accel_x.length > 1) {
            html += `
              <div class="graph-container">
                <div class="graph-title">Accelerometer X History</div>
                <canvas id="graph-accel-x" class="metric-graph" ></canvas>
              </div>
              <div class="graph-container">
                <div class="graph-title">Accelerometer Y History</div>
                <canvas id="graph-accel-y" class="metric-graph" w></canvas>
              </div>
              <div class="graph-container">
                <div class="graph-title">Accelerometer Z History</div>
                <canvas id="graph-accel-z" class="metric-graph" ></canvas>
              </div>
            `;
          }
        }
        
        html += `<div class="timestamp">Updated: ${new Date().toLocaleTimeString()}</div>`;
        container.innerHTML = html;
        
        // Draw graphs if auto-refresh is active
        if (autoRefreshEnabled) {
          setTimeout(() => {
            if (metric_history.light.length > 1) drawGraph('graph-light', metric_history.light, '#FFC107');
            if (metric_history.temperature.length > 1) drawGraph('graph-temp', metric_history.temperature, '#F44336');
            if (metric_history.humidity.length > 1) drawGraph('graph-humidity', metric_history.humidity, '#2196F3');
            if (metric_history.microphone.length > 1) drawGraph('graph-mic', metric_history.microphone, '#9C27B0');
            if (metric_history.accel_x.length > 1) drawGraph('graph-accel-x', metric_history.accel_x, '#4CAF50');
            if (metric_history.accel_y.length > 1) drawGraph('graph-accel-y', metric_history.accel_y, '#4CAF50');
            if (metric_history.accel_z.length > 1) drawGraph('graph-accel-z', metric_history.accel_z, '#4CAF50');
          }, 10);
        }
        
      } catch (error) {
        container.innerHTML = `
          <div class="error-message">
            ‚ùå Error loading sensor data:<br>
            ${error.message}
          </div>
        `;
      }
    }
    
    // Fetch UDP Service metrics
    async function refreshUDP() {
      const container = document.getElementById('udp-content');
      
      try {
        const response = await fetch('/api/udp/v1');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Store values in history if auto-refresh is active
        if (autoRefreshEnabled) {
          addToHistory(metric_history.udp_total, data.total);
          addToHistory(metric_history.udp_dropped, data.dropped);
        }
        
        let html = '';
        
        // Port
        html += `
          <div class="metric-row">
            <span class="metric-label">üîå Port:</span>
            <span class="metric-value metric-highlight">${data.port !== undefined ? data.port : 'N/A'}</span>
          </div>
        `;
        
        // Total messages
        html += `
          <div class="metric-row">
            <span class="metric-label">üì® Total Messages:</span>
            <span class="metric-value metric-highlight">${data.total !== undefined ? data.total : 'N/A'}</span>
          </div>
        `;
        if (autoRefreshEnabled && metric_history.udp_total.length > 1) {
          html += `
            <div class="graph-container">
              <div class="graph-title">Total Messages History</div>
              <canvas id="graph-udp-total" class="metric-graph" ></canvas>
            </div>
          `;
        }
        
        // Dropped packets
        const droppedClass = data.dropped > 0 ? 'metric-warning' : 'metric-highlight';
        html += `
          <div class="metric-row">
            <span class="metric-label">‚ö†Ô∏è Dropped Packets:</span>
            <span class="metric-value ${droppedClass}">${data.dropped !== undefined ? data.dropped : 'N/A'}</span>
          </div>
        `;
        if (autoRefreshEnabled && metric_history.udp_dropped.length > 1) {
          html += `
            <div class="graph-container">
              <div class="graph-title">Dropped Packets History</div>
              <canvas id="graph-udp-dropped" class="metric-graph" ></canvas>
            </div>
          `;
        }
        
        // Buffer usage
        html += `
          <div class="metric-row">
            <span class="metric-label">üíæ Buffer Usage:</span>
            <span class="metric-value">${data.buffer !== undefined ? data.buffer : 'N/A'}</span>
          </div>
        `;
        
        // Error message if any
        if (data.error) {
          html += `
            <div class="metric-row">
              <span class="metric-label">‚ö†Ô∏è Status:</span>
              <span class="metric-value metric-error">${data.error}</span>
            </div>
          `;
        }
        
        // Recent messages
        if (data.messages && Array.isArray(data.messages) && data.messages.length > 0) {
          html += `
            <div class="metric-row">
              <span class="metric-label">üìã Recent Messages (${data.messages.length}):</span>
            </div>
            <div class="messages-list">
          `;
          
          data.messages.forEach((msg, index) => {
            if (msg && msg.trim() !== '') {
              html += `<div class="message-item">${escapeHtml(msg)}</div>`;
            }
          });
          
          html += '</div>';
        }
        
        html += `<div class="timestamp">Updated: ${new Date().toLocaleTimeString()}</div>`;
        container.innerHTML = html;
        
        // Draw graphs if auto-refresh is active
        if (autoRefreshEnabled) {
          setTimeout(() => {
            if (metric_history.udp_total.length > 1) drawGraph('graph-udp-total', metric_history.udp_total, '#03A9F4');
            if (metric_history.udp_dropped.length > 1) drawGraph('graph-udp-dropped', metric_history.udp_dropped, '#FF5722');
          }, 10);
        }
        
      } catch (error) {
        container.innerHTML = `
          <div class="error-message">
            ‚ùå Error loading UDP statistics:<br>
            ${error.message}
          </div>
        `;
      }
    }
    
    // Fetch Board Info metrics
    async function refreshBoardInfo() {
      const container = document.getElementById('board-content');
      
      try {
        const response = await fetch('/api/boardinfo/v1');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        let html = '';
        
        // Board Name
        if (data.board) {
          html += `
            <div class="metric-row">
              <span class="metric-label">üéõÔ∏è Board:</span>
              <span class="metric-value metric-highlight">${data.board}</span>
            </div>
          `;
        }
        
        // Firmware Version
        if (data.version) {
          html += `
            <div class="metric-row">
              <span class="metric-label">üìå Firmware:</span>
              <span class="metric-value">${data.version}</span>
            </div>
          `;
        }
        
        // Chip Model
        if (data.chipModel) {
          html += `
            <div class="metric-row">
              <span class="metric-label">üîå Chip Model:</span>
              <span class="metric-value metric-highlight">${data.chipModel}</span>
            </div>
          `;
        }
        
        // Chip Revision
        if (data.chipRevision !== undefined) {
          html += `
            <div class="metric-row">
              <span class="metric-label">üìù Chip Revision:</span>
              <span class="metric-value">${data.chipRevision}</span>
            </div>
          `;
        }
        
        // CPU Cores
        if (data.chipCores !== undefined) {
          html += `
            <div class="metric-row">
              <span class="metric-label">‚öôÔ∏è CPU Cores:</span>
              <span class="metric-value metric-highlight">${data.chipCores}</span>
            </div>
          `;
        }
        
        // CPU Frequency
        if (data.cpuFreqMHz !== undefined) {
          html += `
            <div class="metric-row">
              <span class="metric-label">‚ö° CPU Frequency:</span>
              <span class="metric-value">${data.cpuFreqMHz} MHz</span>
            </div>
          `;
        }
        
        // Uptime
        if (data.uptimeMs !== undefined) {
          const uptimeSeconds = Math.floor(data.uptimeMs / 1000);
          const hours = Math.floor(uptimeSeconds / 3600);
          const minutes = Math.floor((uptimeSeconds % 3600) / 60);
          const seconds = uptimeSeconds % 60;
          html += `
            <div class="metric-row">
              <span class="metric-label">‚è±Ô∏è Uptime:</span>
              <span class="metric-value">${hours}h ${minutes}m ${seconds}s</span>
            </div>
          `;
        }
        
        // Free Heap
        if (data.heapFree !== undefined) {
          const heapClass = data.heapFree < 50000 ? 'metric-warning' : 'metric-highlight';
          const heapKB = (data.heapFree / 1024).toFixed(1);
          html += `
            <div class="metric-row">
              <span class="metric-label">üíæ Free Heap:</span>
              <span class="metric-value ${heapClass}">${heapKB} KB</span>
            </div>
          `;
        }
        
        // Total Heap
        if (data.heapTotal !== undefined) {
          const heapKB = (data.heapTotal / 1024).toFixed(1);
          html += `
            <div class="metric-row">
              <span class="metric-label">üíΩ Total Heap:</span>
              <span class="metric-value">${heapKB} KB</span>
            </div>
          `;
        }
        
        // Free Sketch Space
        if (data.freeSketchSpace !== undefined) {
          const sketchKB = (data.freeSketchSpace / 1024).toFixed(1);
          html += `
            <div class="metric-row">
              <span class="metric-label">üì¶ Free Flash:</span>
              <span class="metric-value">${sketchKB} KB</span>
            </div>
          `;
        }
        
        // SDK Version
        if (data.sdkVersion) {
          html += `
            <div class="metric-row">
              <span class="metric-label">üõ†Ô∏è SDK Version:</span>
              <span class="metric-value">${data.sdkVersion}</span>
            </div>
          `;
        }
        
        html += `<div class="timestamp">Updated: ${new Date().toLocaleTimeString()}</div>`;
        container.innerHTML = html;
        
      } catch (error) {
        container.innerHTML = `
          <div class="error-message">
            ‚ùå Error loading board information:<br>
            ${error.message}
          </div>
        `;
      }
    }
    
    // Refresh all metrics
    async function refreshAllMetrics() {
      try {
        await Promise.all([
          refreshBoardInfo(),
          refreshSensors(),
          refreshUDP()
        ]);
        const titleStatus = document.getElementById('titleStatus');
        if (titleStatus) {
          titleStatus.textContent = '[Active]';
          titleStatus.style.color = '#4CAF50';
        }
      } catch (error) {
        const titleStatus = document.getElementById('titleStatus');
        if (titleStatus) {
          titleStatus.textContent = '[Error]';
          titleStatus.style.color = '#f44336';
        }
      }
    }
    
    // HTML escape helper
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Auto-refresh every 1 second
    let autoRefreshEnabled = false;
    let autoRefreshInterval = null;
    
    function toggleAutoRefresh() {
      autoRefreshEnabled = !autoRefreshEnabled;
      const btn = document.getElementById('autoRefreshBtn');
      
      if (autoRefreshEnabled) {
        autoRefreshInterval = setInterval(refreshAllMetrics, 1000);
        btn.textContent = '‚è±Ô∏è Auto-Refresh: ON';
        btn.style.background = '#4CAF50';
        btn.style.color = 'white';
      } else {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
        btn.textContent = '‚è±Ô∏è Auto-Refresh: OFF';
        btn.style.background = '';
        btn.style.color = '';
      }
    }
    
    // Initial load
    window.addEventListener('DOMContentLoaded', () => {
      refreshAllMetrics();
    });
  </script>
</body>
</html>
