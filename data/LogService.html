<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Rolling Logs - K10 Bot</title>
  <link rel="stylesheet" href="./style.css">
  <style>
    .log-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin: 20px 0;
    }
    
    .log-section {
      background: #1a1a1a;
      border-radius: 8px;
      padding: 20px;
      border: 2px solid #444;
    }
    
    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #444;
    }
    
    .log-title {
      font-size: 20px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .log-count {
      font-size: 14px;
      color: #888;
      background: #2a2a2a;
      padding: 5px 10px;
      border-radius: 4px;
    }
    
    .log-entries {
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 500px;
      overflow-y: auto;
      background: #0a0a0a;
      padding: 15px;
      border-radius: 4px;
      border: 1px solid #333;
    }
    
    .log-entry {
      margin: 5px 0;
      padding: 8px;
      border-radius: 3px;
      display: flex;
      gap: 10px;
      align-items: start;
      border-left: 3px solid transparent;
    }
    
    .log-level {
      font-weight: bold;
      min-width: 70px;
      text-align: center;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
    }
    
    .log-message {
      flex: 1;
      word-break: break-word;
      color: #ccc;
    }
    
    .log-entry.TRACE {
      background: #1a1a2e;
      border-left-color: #666;
    }
    
    .log-entry.TRACE .log-level {
      background: #555;
      color: #ccc;
    }
    
    .log-entry.DEBUG {
      background: #1a1a2e;
      border-left-color: #3498db;
    }
    
    .log-entry.DEBUG .log-level {
      background: #3498db;
      color: #fff;
    }
    
    .log-entry.INFO {
      background: #1e2a1e;
      border-left-color: #4CAF50;
    }
    
    .log-entry.INFO .log-level {
      background: #4CAF50;
      color: #fff;
    }
    
    .log-entry.WARNING {
      background: #2a2a1a;
      border-left-color: #FFA500;
    }
    
    .log-entry.WARNING .log-level {
      background: #FFA500;
      color: #000;
    }
    
    .log-entry.ERROR {
      background: #2a1a1a;
      border-left-color: #f44336;
    }
    
    .log-entry.ERROR .log-level {
      background: #f44336;
      color: #fff;
    }
    
    .controls {
      margin: 20px 0;
      padding: 15px;
      background: #1a1a1a;
      border-radius: 8px;
      border: 2px solid #444;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    
    .btn-primary:hover {
      background: #45a049;
    }
    
    .btn-secondary {
      background: #2196F3;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #0b7dda;
    }
    
    .auto-refresh-control {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #ccc;
    }
    
    .auto-refresh-control label {
      cursor: pointer;
    }
    
    .auto-refresh-control input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .filter-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .filter-btn {
      padding: 6px 12px;
      border: 2px solid #444;
      border-radius: 4px;
      background: #2a2a2a;
      color: #ccc;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }
    
    .filter-btn.active {
      border-color: #4CAF50;
      background: #4CAF50;
      color: #fff;
    }
    
    .filter-btn:hover {
      background: #3a3a3a;
    }
    
    .filter-btn.active:hover {
      background: #45a049;
    }
    
    .empty-log {
      text-align: center;
      color: #666;
      padding: 40px;
      font-style: italic;
    }
    
    .error-message {
      background: #2a1a1a;
      border: 2px solid #f44336;
      border-radius: 8px;
      padding: 20px;
      color: #f44336;
      text-align: center;
      margin: 20px 0;
    }
    
    .loading {
      text-align: center;
      color: #4CAF50;
      padding: 40px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <h1 id="pageTitle">K10 Bot - Rolling Logs <span id="titleStatus" style="font-size: 0.6em; color: #999;"></span></h1>
  
  <div class="controls">
    <button class="btn btn-primary" onclick="refreshLogs()">ðŸ”„ Refresh Now</button>
    <button class="btn btn-secondary" onclick="exportLogs()">ðŸ’¾ Export All Logs</button>
    
    <div class="auto-refresh-control">
      <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
      <label for="autoRefresh">Auto-refresh every 5s</label>
    </div>
    
    <div class="filter-controls">
      <span style="color: #888;">Filter:</span>
      <button class="filter-btn active" data-level="TRACE" onclick="toggleFilter('TRACE')">TRACE</button>
      <button class="filter-btn active" data-level="DEBUG" onclick="toggleFilter('DEBUG')">DEBUG</button>
      <button class="filter-btn active" data-level="INFO" onclick="toggleFilter('INFO')">INFO</button>
      <button class="filter-btn active" data-level="WARNING" onclick="toggleFilter('WARNING')">WARNING</button>
      <button class="filter-btn active" data-level="ERROR" onclick="toggleFilter('ERROR')">ERROR</button>
    </div>
  </div>
  
  <div id="logContainer" class="log-container">
    <div class="loading">Loading logs...</div>
  </div>
  
  <script>
    let autoRefreshInterval = null;
    const activeFilters = new Set(['TRACE', 'DEBUG', 'INFO', 'WARNING', 'ERROR']);
    
    function toggleFilter(level) {
      const btn = document.querySelector(`.filter-btn[data-level="${level}"]`);
      if (activeFilters.has(level)) {
        activeFilters.delete(level);
        btn.classList.remove('active');
      } else {
        activeFilters.add(level);
        btn.classList.add('active');
      }
      refreshLogs();
    }
    
    function shouldShowEntry(level) {
      return activeFilters.has(level);
    }
    
    function toggleAutoRefresh() {
      const checkbox = document.getElementById('autoRefresh');
      if (checkbox.checked) {
        autoRefreshInterval = setInterval(refreshLogs, 5000);
      } else {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
      }
    }
    
    function createLogEntry(entry) {
      if (!shouldShowEntry(entry.level)) {
        return null;
      }
      
      const div = document.createElement('div');
      div.className = `log-entry ${entry.level}`;
      
      const levelSpan = document.createElement('span');
      levelSpan.className = 'log-level';
      levelSpan.textContent = entry.level;
      
      const messageSpan = document.createElement('span');
      messageSpan.className = 'log-message';
      messageSpan.textContent = entry.message;
      
      div.appendChild(levelSpan);
      div.appendChild(messageSpan);
      
      return div;
    }
    
    function renderLogSection(title, logs, id) {
      const section = document.createElement('div');
      section.className = 'log-section';
      
      const header = document.createElement('div');
      header.className = 'log-header';
      
      const titleDiv = document.createElement('div');
      titleDiv.className = 'log-title';
      titleDiv.textContent = title;
      
      const visibleCount = logs.filter(log => shouldShowEntry(log.level)).length;
      const countDiv = document.createElement('div');
      countDiv.className = 'log-count';
      countDiv.textContent = `${visibleCount} / ${logs.length} entries`;
      
      header.appendChild(titleDiv);
      header.appendChild(countDiv);
      
      const entries = document.createElement('div');
      entries.className = 'log-entries';
      entries.id = id;
      
      if (visibleCount === 0) {
        const empty = document.createElement('div');
        empty.className = 'empty-log';
        empty.textContent = logs.length === 0 ? 'No log entries' : 'All entries filtered out';
        entries.appendChild(empty);
      } else {
        logs.forEach(log => {
          const entry = createLogEntry(log);
          if (entry) {
            entries.appendChild(entry);
          }
        });
      }
      
      section.appendChild(header);
      section.appendChild(entries);
      
      return section;
    }
    
    async function refreshLogs() {
      try {
        const response = await fetch('/api/logs/v1/all');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        const container = document.getElementById('logContainer');
        container.innerHTML = '';
        
        // Render debug logs
        if (data.debug) {
          container.appendChild(renderLogSection('Debug Logger', data.debug, 'debugLogs'));
        }
        
        // Render app info logs
        if (data.app_info) {
          container.appendChild(renderLogSection('App Info Logger', data.app_info, 'appInfoLogs'));
        }
        
        // Auto-scroll to bottom of each log section
        document.querySelectorAll('.log-entries').forEach(el => {
          el.scrollTop = el.scrollHeight;
        });
        
        // Update title status
        const titleStatus = document.getElementById('titleStatus');
        if (titleStatus) {
          const totalLogs = (data.debug?.length || 0) + (data.app_info?.length || 0);
          titleStatus.textContent = `[${totalLogs} entries]`;
          titleStatus.style.color = '#4CAF50';
        }
        
      } catch (error) {
        console.error('Failed to fetch logs:', error);
        const container = document.getElementById('logContainer');
        container.innerHTML = `
          <div class="error-message">
            <strong>Error loading logs:</strong><br>
            ${error.message}
          </div>
        `;
      }
    }
    
    async function exportLogs() {
      try {
        const response = await fetch('/api/logs/v1/all');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        const exportData = {
          timestamp: new Date().toISOString(),
          debug: data.debug || [],
          app_info: data.app_info || []
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `k10-logs-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
      } catch (error) {
        console.error('Failed to export logs:', error);
        alert('Failed to export logs: ' + error.message);
      }
    }
    
    // Initial load
    refreshLogs();
  </script>
</body>
</html>
