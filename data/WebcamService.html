<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Webcam Control - K10 Bot</title>
  <link rel="stylesheet" href="./style.css">
  <style>
    .webcam-container {
      max-width: 900px;
      margin: 0 auto;
    }
    .mode-selector {
      background: white;
      padding: 20px;
      margin: 15px 0;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .mode-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .mode-btn {
      flex: 1;
      padding: 15px;
      border: 2px solid #ddd;
      background: white;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s;
    }
    .mode-btn:hover {
      border-color: #4CAF50;
      transform: translateY(-2px);
    }
    .mode-btn.active {
      background: #4CAF50;
      color: white;
      border-color: #4CAF50;
    }
    .mode-btn.off {
      border-color: #f44336;
    }
    .mode-btn.off.active {
      background: #f44336;
      border-color: #f44336;
    }
    .camera-viewport {
      background: white;
      padding: 20px;
      margin: 15px 0;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-height: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .camera-image-container {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f5f5f5;
      border-radius: 5px;
      min-height: 480px;
      position: relative;
    }
    .camera-image {
      max-width: 100%;
      height: auto;
      border-radius: 5px;
      display: none;
    }
    .camera-image.visible {
      display: block;
    }
    .placeholder {
      color: #999;
      font-size: 18px;
      text-align: center;
    }
    .camera-controls {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      width: 100%;
      justify-content: center;
    }
    .status-bar {
      background: #f9f9f9;
      padding: 10px 20px;
      margin: 15px 0;
      border-radius: 5px;
      border-left: 4px solid #2196F3;
      font-size: 14px;
    }
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-indicator.active {
      background: #4CAF50;
      box-shadow: 0 0 8px #4CAF50;
    }
    .status-indicator.inactive {
      background: #999;
    }
    .error-message {
      color: #f44336;
      background: #ffebee;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      display: none;
    }
    .error-message.visible {
      display: block;
    }
  </style>
</head>
<body>
  <div class="webcam-container">
    <h1 id="pageTitle">üì∑ Webcam Control <span id="titleStatus" style="font-size: 0.6em; color: #999;"></span></h1>
    
    <div class="panel">
      <a href="/" class="btn">‚Üê Back to Home</a>
      <button onclick="refreshStatus()" class="btn">üîÑ Refresh Status</button>
    </div>

    <div class="status-bar">
      <span class="status-indicator inactive" id="statusIndicator"></span>
      <span id="statusText">Camera status: Loading...</span>
    </div>

    <div class="mode-selector">
      <h2>Camera Mode</h2>
      <div class="mode-buttons">
        <button class="mode-btn off active" onclick="setMode('off')" id="btnOff">
          ‚èπÔ∏è Off
        </button>
        <button class="mode-btn" onclick="setMode('snapshot')" id="btnSnapshot">
          üì∏ Snapshot
        </button>
        <button class="mode-btn" onclick="setMode('stream')" id="btnStream">
          üé• Live Stream
        </button>
      </div>
    </div>

    <div class="error-message" id="errorMessage"></div>

    <div class="camera-viewport">
      <div class="camera-image-container">
        <img src="" alt="Camera view" class="camera-image" id="cameraImage">
        <div class="placeholder" id="placeholder">
          Camera is off. Select a mode to view the camera feed.
        </div>
      </div>
      <div class="camera-controls" id="cameraControls" style="display: none;">
        <button onclick="captureSnapshot()" class="btn" id="btnCapture">
          üì∏ Capture New Snapshot
        </button>
        <button onclick="downloadImage()" class="btn" id="btnDownload">
          üíæ Download Image
        </button>
      </div>
    </div>
  </div>

  <script>
    let currentMode = 'off';
    let streamCheckInterval = null;

    function setMode(mode) {
      // Clear any existing intervals
      if (streamCheckInterval) {
        clearInterval(streamCheckInterval);
        streamCheckInterval = null;
      }

      // Update button states
      document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`btn${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');

      currentMode = mode;
      hideError();

      const image = document.getElementById('cameraImage');
      const placeholder = document.getElementById('placeholder');
      const controls = document.getElementById('cameraControls');

      if (mode === 'off') {
        image.src = '';
        image.classList.remove('visible');
        placeholder.style.display = 'block';
        placeholder.textContent = 'Camera is off. Select a mode to view the camera feed.';
        controls.style.display = 'none';
      } else if (mode === 'snapshot') {
        placeholder.textContent = 'Loading snapshot...';
        captureSnapshot();
        controls.style.display = 'flex';
      } else if (mode === 'stream') {
        placeholder.style.display = 'none';
        image.classList.add('visible');
        image.src = '/api/webcam/v1/stream?' + new Date().getTime();
        controls.style.display = 'none';
        
        // Monitor stream connection
        streamCheckInterval = setInterval(() => {
          if (image.naturalWidth === 0) {
            showError('Stream connection lost. Click Stream again to reconnect.');
          }
        }, 5000);
      }
    }

    async function captureSnapshot() {
      const image = document.getElementById('cameraImage');
      const placeholder = document.getElementById('placeholder');
      
      try {
        placeholder.textContent = 'Capturing snapshot...';
        
        // Add timestamp to prevent caching
        const timestamp = new Date().getTime();
        const response = await fetch(`/api/webcam/v1/snapshot?t=${timestamp}`);
        
        if (response.status === 409) {
          showError('Cannot capture snapshot while streaming is active. Stop the stream first.');
          return;
        }
        
        if (!response.ok) {
          throw new Error(`Failed to capture snapshot: ${response.status} ${response.statusText}`);
        }
        
        const blob = await response.blob();
        const imageUrl = URL.createObjectURL(blob);
        
        image.onload = () => {
          placeholder.style.display = 'none';
          image.classList.add('visible');
          hideError();
        };
        
        image.onerror = () => {
          showError('Failed to load snapshot image');
          placeholder.style.display = 'block';
          placeholder.textContent = 'Failed to load image';
        };
        
        image.src = imageUrl;
        
      } catch (error) {
        console.error('Snapshot error:', error);
        showError('Failed to capture snapshot: ' + error.message);
        placeholder.style.display = 'block';
        placeholder.textContent = 'Failed to capture snapshot';
      }
    }

    async function refreshStatus() {
      try {
        const response = await fetch('/api/webcam/v1/serviceStatus');
        const data = await response.json();
        
        const indicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const titleStatus = document.getElementById('titleStatus');
        
        if (data.initialized && data.status === 'ready') {
          indicator.classList.add('active');
          indicator.classList.remove('inactive');
          statusText.textContent = 'Camera status: Ready';
          titleStatus.textContent = '[Ready]';
          titleStatus.style.color = '#4CAF50';
          hideError();
        } else {
          indicator.classList.remove('active');
          indicator.classList.add('inactive');
          statusText.textContent = `Camera status: ${data.status || 'Not ready'}`;
          titleStatus.textContent = `[${data.status || 'Not ready'}]`;
          titleStatus.style.color = '#f44336';
          if (!data.initialized) {
            showError('Camera is not initialized');
          }
        }
        
        if (data.settings) {
          statusText.textContent += ` | Resolution: ${data.settings.framesize_name || 'Unknown'} | Quality: ${data.settings.quality || 'N/A'}`;
        }
        
      } catch (error) {
        console.error('Status check failed:', error);
        document.getElementById('statusText').textContent = 'Camera status: Error fetching status';
        showError('Failed to get camera status: ' + error.message);
      }
    }

    function downloadImage() {
      const image = document.getElementById('cameraImage');
      if (!image.src || image.src === '') {
        showError('No image to download');
        return;
      }
      
      const link = document.createElement('a');
      link.href = image.src;
      link.download = `k10-snapshot-${new Date().getTime()}.jpg`;
      link.click();
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.add('visible');
    }

    function hideError() {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.classList.remove('visible');
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      refreshStatus();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (streamCheckInterval) {
        clearInterval(streamCheckInterval);
      }
    });
  </script>
</body>
</html>
